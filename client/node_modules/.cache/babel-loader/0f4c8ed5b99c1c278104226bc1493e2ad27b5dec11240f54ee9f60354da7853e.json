{"ast":null,"code":"import _objectSpread from\"F:/Web-Development/chat-app/client/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useContext,useCallback}from'react';import{useNavigate}from'react-router-dom';import{io}from'socket.io-client';import{AuthContext}from'../context/AuthContext';import{authAPI,messageAPI}from'../services/api';import ChatBox from'../components/ChatBox';import UserList from'../components/UserList';import'./Chat.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const Chat=()=>{const{user,logout}=useContext(AuthContext);const[users,setUsers]=useState([]);const[selectedUser,setSelectedUser]=useState(null);const[messages,setMessages]=useState([]);const[socket,setSocket]=useState(null);const[onlineUsers,setOnlineUsers]=useState([]);const[isTyping,setIsTyping]=useState(false);const navigate=useNavigate();// Socket Setup\nuseEffect(()=>{if(!(user!==null&&user!==void 0&&user.id))return;console.log('ðŸ”Œ Socket setup...');const newSocket=io(process.env.REACT_APP_API_URL);newSocket.on('connect',()=>{console.log('âœ… Connected');newSocket.emit('user_online',user.id);});newSocket.on('users_online',userIds=>{setOnlineUsers(Array.isArray(userIds)?userIds:[]);});newSocket.on('receive_message',data=>{console.log('ðŸ’¬ Message received');setMessages(prev=>[...prev,{_id:data._id,sender:data.sender,text:data.text,seen:false,timestamp:data.timestamp}]);});// Listen for messages_seen\nnewSocket.on('messages_seen',data=>{console.log('ðŸ‘€ MESSAGES_SEEN received:',data);setMessages(prev=>prev.map(msg=>msg.sender===user.id?_objectSpread(_objectSpread({},msg),{},{seen:true}):msg));});newSocket.on('user_typing',()=>setIsTyping(true));newSocket.on('user_stopped_typing',()=>setIsTyping(false));setSocket(newSocket);return()=>newSocket.disconnect();},[user===null||user===void 0?void 0:user.id]);// Fetch users\nuseEffect(()=>{const fetchUsers=async()=>{try{const{data}=await authAPI.getUsers();setUsers(data||[]);}catch(error){console.error('Failed to fetch users');}};fetchUsers();},[]);// Fetch messages and emit mark_seen\nuseEffect(()=>{if(!selectedUser||!(user!==null&&user!==void 0&&user.id)||!socket)return;const loadMessages=async()=>{try{console.log('ðŸ“¨ Loading messages...');const{data}=await messageAPI.getMessages(selectedUser._id);setMessages(data||[]);// âœ… Emit mark_seen AFTER loading\nconsole.log('ðŸ‘€ Emitting mark_seen');socket.emit('mark_seen',{senderId:selectedUser._id,receiverId:user.id});}catch(error){console.error('Failed to load messages');}};loadMessages();},[selectedUser,user===null||user===void 0?void 0:user.id,socket]);// Send message\nconst handleSendMessage=useCallback(text=>{if(!socket||!selectedUser||!(user!==null&&user!==void 0&&user.id))return;socket.emit('send_message',{sender:user.id,receiver:selectedUser._id,text});setMessages(prev=>[...prev,{_id:Date.now(),sender:user.id,text,seen:false,timestamp:new Date()}]);},[socket,selectedUser,user===null||user===void 0?void 0:user.id]);const handleTyping=useCallback(()=>{if(socket&&selectedUser){socket.emit('typing',{receiver:selectedUser._id});}},[socket,selectedUser]);const handleStopTyping=useCallback(()=>{if(socket&&selectedUser){socket.emit('stop_typing',{receiver:selectedUser._id});}},[socket,selectedUser]);const handleLogout=()=>{if(socket)socket.disconnect();logout();navigate('/login');};return/*#__PURE__*/_jsxs(\"div\",{className:\"chat-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"header\",children:[/*#__PURE__*/_jsx(\"h1\",{children:\"\\uD83D\\uDCAC Chat App\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"user-info\",children:[/*#__PURE__*/_jsx(\"span\",{children:user===null||user===void 0?void 0:user.username}),/*#__PURE__*/_jsx(\"button\",{onClick:handleLogout,children:\"Logout\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-wrapper\",children:[/*#__PURE__*/_jsx(UserList,{users:users,selectedUser:selectedUser,onlineUsers:onlineUsers,onSelectUser:setSelectedUser}),/*#__PURE__*/_jsx(ChatBox,{selectedUser:selectedUser,messages:messages,currentUser:user,onSendMessage:handleSendMessage,onTyping:handleTyping,onStopTyping:handleStopTyping,isTyping:isTyping})]})]});};export default Chat;","map":{"version":3,"names":["React","useState","useEffect","useContext","useCallback","useNavigate","io","AuthContext","authAPI","messageAPI","ChatBox","UserList","jsx","_jsx","jsxs","_jsxs","Chat","user","logout","users","setUsers","selectedUser","setSelectedUser","messages","setMessages","socket","setSocket","onlineUsers","setOnlineUsers","isTyping","setIsTyping","navigate","id","console","log","newSocket","process","env","REACT_APP_API_URL","on","emit","userIds","Array","isArray","data","prev","_id","sender","text","seen","timestamp","map","msg","_objectSpread","disconnect","fetchUsers","getUsers","error","loadMessages","getMessages","senderId","receiverId","handleSendMessage","receiver","Date","now","handleTyping","handleStopTyping","handleLogout","className","children","username","onClick","onSelectUser","currentUser","onSendMessage","onTyping","onStopTyping"],"sources":["F:/Web-Development/chat-app/client/src/pages/Chat.jsx"],"sourcesContent":["\r\nimport React, { useState, useEffect, useContext, useCallback } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { io } from 'socket.io-client';\r\nimport { AuthContext } from '../context/AuthContext';\r\nimport { authAPI, messageAPI } from '../services/api';\r\nimport ChatBox from '../components/ChatBox';\r\nimport UserList from '../components/UserList';\r\nimport './Chat.css';\r\n\r\nconst Chat = () => {\r\n    const { user, logout } = useContext(AuthContext);\r\n    const [users, setUsers] = useState([]);\r\n    const [selectedUser, setSelectedUser] = useState(null);\r\n    const [messages, setMessages] = useState([]);\r\n    const [socket, setSocket] = useState(null);\r\n    const [onlineUsers, setOnlineUsers] = useState([]);\r\n    const [isTyping, setIsTyping] = useState(false);\r\n    const navigate = useNavigate();\r\n\r\n    // Socket Setup\r\n    useEffect(() => {\r\n        if (!user?.id) return;\r\n\r\n        console.log('ðŸ”Œ Socket setup...');\r\n        const newSocket = io(process.env.REACT_APP_API_URL);\r\n\r\n        newSocket.on('connect', () => {\r\n            console.log('âœ… Connected');\r\n            newSocket.emit('user_online', user.id);\r\n        });\r\n\r\n        newSocket.on('users_online', (userIds) => {\r\n            setOnlineUsers(Array.isArray(userIds) ? userIds : []);\r\n        });\r\n\r\n        newSocket.on('receive_message', (data) => {\r\n            console.log('ðŸ’¬ Message received');\r\n            setMessages(prev => [...prev, {\r\n                _id: data._id,\r\n                sender: data.sender,\r\n                text: data.text,\r\n                seen: false,\r\n                timestamp: data.timestamp\r\n            }]);\r\n        });\r\n\r\n        // Listen for messages_seen\r\n        newSocket.on('messages_seen', (data) => {\r\n            console.log('ðŸ‘€ MESSAGES_SEEN received:', data);\r\n\r\n            setMessages(prev =>\r\n                prev.map(msg =>\r\n                    msg.sender === user.id ? { ...msg, seen: true } : msg\r\n                )\r\n            );\r\n        });\r\n\r\n        newSocket.on('user_typing', () => setIsTyping(true));\r\n        newSocket.on('user_stopped_typing', () => setIsTyping(false));\r\n\r\n        setSocket(newSocket);\r\n\r\n        return () => newSocket.disconnect();\r\n    }, [user?.id]);\r\n\r\n    // Fetch users\r\n    useEffect(() => {\r\n        const fetchUsers = async () => {\r\n            try {\r\n                const { data } = await authAPI.getUsers();\r\n                setUsers(data || []);\r\n            } catch (error) {\r\n                console.error('Failed to fetch users');\r\n            }\r\n        };\r\n        fetchUsers();\r\n    }, []);\r\n\r\n    // Fetch messages and emit mark_seen\r\n    useEffect(() => {\r\n        if (!selectedUser || !user?.id || !socket) return;\r\n\r\n        const loadMessages = async () => {\r\n            try {\r\n                console.log('ðŸ“¨ Loading messages...');\r\n                const { data } = await messageAPI.getMessages(selectedUser._id);\r\n                setMessages(data || []);\r\n\r\n                // âœ… Emit mark_seen AFTER loading\r\n                console.log('ðŸ‘€ Emitting mark_seen');\r\n                socket.emit('mark_seen', {\r\n                    senderId: selectedUser._id,\r\n                    receiverId: user.id\r\n                });\r\n            } catch (error) {\r\n                console.error('Failed to load messages');\r\n            }\r\n        };\r\n\r\n        loadMessages();\r\n    }, [selectedUser, user?.id, socket]);\r\n\r\n    // Send message\r\n    const handleSendMessage = useCallback((text) => {\r\n        if (!socket || !selectedUser || !user?.id) return;\r\n\r\n        socket.emit('send_message', {\r\n            sender: user.id,\r\n            receiver: selectedUser._id,\r\n            text\r\n        });\r\n\r\n        setMessages(prev => [...prev, {\r\n            _id: Date.now(),\r\n            sender: user.id,\r\n            text,\r\n            seen: false,\r\n            timestamp: new Date()\r\n        }]);\r\n    }, [socket, selectedUser, user?.id]);\r\n\r\n    const handleTyping = useCallback(() => {\r\n        if (socket && selectedUser) {\r\n            socket.emit('typing', { receiver: selectedUser._id });\r\n        }\r\n    }, [socket, selectedUser]);\r\n\r\n    const handleStopTyping = useCallback(() => {\r\n        if (socket && selectedUser) {\r\n            socket.emit('stop_typing', { receiver: selectedUser._id });\r\n        }\r\n    }, [socket, selectedUser]);\r\n\r\n    const handleLogout = () => {\r\n        if (socket) socket.disconnect();\r\n        logout();\r\n        navigate('/login');\r\n    };\r\n\r\n    return (\r\n        <div className=\"chat-container\">\r\n            <div className=\"header\">\r\n                <h1>ðŸ’¬ Chat App</h1>\r\n                <div className=\"user-info\">\r\n                    <span>{user?.username}</span>\r\n                    <button onClick={handleLogout}>Logout</button>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"chat-wrapper\">\r\n                <UserList\r\n                    users={users}\r\n                    selectedUser={selectedUser}\r\n                    onlineUsers={onlineUsers}\r\n                    onSelectUser={setSelectedUser}\r\n                />\r\n\r\n                <ChatBox\r\n                    selectedUser={selectedUser}\r\n                    messages={messages}\r\n                    currentUser={user}\r\n                    onSendMessage={handleSendMessage}\r\n                    onTyping={handleTyping}\r\n                    onStopTyping={handleStopTyping}\r\n                    isTyping={isTyping}\r\n                />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Chat;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}